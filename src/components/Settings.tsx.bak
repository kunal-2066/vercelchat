import React, { useState, useEffect } from 'react';
import { useAuth } from '../hooks/useAuth';
import { supabase } from '../utils/supabaseClient';

interface SettingsProps {
  isOpen: boolean;
  onClose: () => void;
}

export const Settings: React.FC<SettingsProps> = ({ isOpen, onClose }) => {
  const { user } = useAuth();
  const [nickname, setNickname] = useState('');
  const [loading, setLoading] = useState(false);
  const [message, setMessage] = useState('');
  const [soundEnabled, setSoundEnabled] = useState(false);
  const [notificationsEnabled, setNotificationsEnabled] = useState(true);

  // Load user settings from Supabase
  useEffect(() => {
    const loadSettings = async () => {
      if (!user) return;

      try {
        const { data, error } = await supabase
          .from('user_profiles')
          .select('nickname, sound_enabled, notifications_enabled')
          .eq('user_id', user.id)
          .single();

        if (error && error.code !== 'PGRST116') {
          // PGRST116 is "not found" error, which is ok for new users
          console.warn('Error loading settings:', error);
          return;
        }

        if (data) {
          setNickname(data.nickname || '');
          setSoundEnabled(data.sound_enabled || false);
          setNotificationsEnabled(data.notifications_enabled !== false);
        }
      } catch (err) {
        console.error('Failed to load settings:', err);
      }
    };

    if (isOpen) {
      loadSettings();
    }
  }, [isOpen, user]);

  const handleSave = async () => {
    if (!user) {
      setMessage('‚ö†Ô∏è Please sign in to save settings.');
      return;
    }

    setLoading(true);
    setMessage('');

    console.log('Saving settings for user:', user.id);
    console.log('User object:', user);
    console.log('Starting save at:', new Date().toISOString());

    // Add timeout to prevent infinite loading
    const timeout = setTimeout(() => {
      console.log('TIMEOUT triggered at:', new Date().toISOString());
      setLoading(false);
      setMessage('‚ö†Ô∏è Save timeout. This means RLS policies are blocking the write. Please run DEFINITIVE_FIX.sql in Supabase SQL Editor.');
    }, 8000); // 8 second timeout

    try {
      // First verify we have an active session
      const { data: { session }, error: sessionError } = await supabase.auth.getSession();
      if (sessionError || !session) {
        clearTimeout(timeout);
        setLoading(false);
        setMessage('‚ö†Ô∏è Authentication error. Please sign out and sign in again.');
        console.error('No active session:', sessionError);
        return;
      }

      console.log('Active session confirmed for user:', session.user.id);
      console.log('Session expires at:', new Date(session.expires_at * 1000).toISOString());
      
      // Check if session is expired
      if (session.expires_at * 1000 < Date.now()) {
        clearTimeout(timeout);
        setLoading(false);
        setMessage('‚ö†Ô∏è Session expired. Please sign out and sign in again.');
        console.error('Session is expired');
        return;
      }

      const upsertData = {
        user_id: user.id,
        nickname: nickname.trim() || null,
        sound_enabled: soundEnabled,
        notifications_enabled: notificationsEnabled,
        updated_at: new Date().toISOString(),
      };
      
      console.log('Upserting data:', upsertData);
      console.log('Calling supabase.from().upsert() now...');
      
      const startTime = Date.now();
      
      console.log('‚è≥ About to call Supabase upsert...');
      console.log('üìù Data to upsert:', JSON.stringify(upsertData, null, 2));
      
      // Add a race condition with timeout to see if request completes
      const upsertPromise = supabase
        .from('user_profiles')
        .upsert(upsertData, { 
          onConflict: 'user_id',
          ignoreDuplicates: false 
        });
      
      console.log('‚è≥ Waiting for upsert response...');
      
      // Race the upsert against a shorter timeout to see when it hangs
      const raceTimeout = new Promise((_, reject) => {
        setTimeout(() => reject(new Error('Internal race timeout - request hung')), 5000);
      });
      
      let upsertResult;
      try {
        upsertResult = await Promise.race([upsertPromise, raceTimeout]);
        console.log('‚úÖ Upsert completed (without select)');
      } catch (raceError) {
        console.error('‚ùå Upsert timed out internally:', raceError);
        throw raceError;
      }
      
      console.log('üìä Upsert result:', upsertResult);
      
      if (upsertResult.error) {
        console.error('üî¥ Full error object:', JSON.stringify(upsertResult.error, null, 2));
      }
      
      const { error } = upsertResult;
      
      console.log('‚úÖ Supabase call completed in:', Date.now() - startTime, 'ms');
      console.log('üìä Final result - error:', error);

      clearTimeout(timeout);

      if (error) {
        console.error('Supabase error:', error);
        console.error('Error code:', error.code);
        console.error('Error message:', error.message);
        console.error('Error details:', error.details);
        console.error('Error hint:', error.hint);
        
        // Handle specific error codes
        if (error.code === '42501') {
          setMessage('‚ö†Ô∏è Permission denied. RLS policy may be blocking the save. Check Supabase dashboard.');
        } else if (error.code === 'PGRST204' || error.code === '42P01') {
          setMessage('‚ö†Ô∏è Database table not found. Please run supabase-schema.sql first.');
        } else if (error.message?.includes('relation')) {
          setMessage('‚ö†Ô∏è Database not set up. Please run supabase-schema.sql first.');
        } else if (error.message?.includes('JWT')) {
          setMessage('‚ö†Ô∏è Authentication token expired. Please sign in again.');
        } else {
          setMessage(`‚ö†Ô∏è Error: ${error.message}`);
        }
        
        setLoading(false);
        return;
      }

      console.log('‚úÖ Settings saved successfully');
      setMessage('‚úÖ Settings saved successfully!');
      
      // Trigger a custom event to notify components to reload nickname
      window.dispatchEvent(new CustomEvent('settingsUpdated'));
      
      setTimeout(() => {
        setMessage('');
        onClose();
      }, 1500);
    } catch (err: any) {
      clearTimeout(timeout);
      console.error('Failed to save settings:', err);
      console.error('Error stack:', err.stack);
      setMessage(err.message || 'Failed to save settings. Please try again.');
    } finally {
      setLoading(false);
    }
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
      {/* Backdrop */}
      <div 
        className="absolute inset-0 bg-mindpex-dark/80 backdrop-blur-md"
        onClick={onClose}
      />

      {/* Modal */}
      <div className="relative w-full max-w-md">
        {/* Warm glow */}
        <div className="absolute inset-0 bg-gradient-to-br from-amber/10 via-transparent to-amber-glow/10 rounded-3xl blur-2xl" />
        
        {/* Content */}
        <div className="relative backdrop-blur-2xl bg-mindpex-dark-warm/90 
                      border border-amber/30 rounded-3xl p-6 shadow-2xl">
          
          {/* Header */}
          <div className="flex items-center justify-between mb-6">
            <h2 className="text-2xl font-semibold text-slate-200">Settings</h2>
            <button
              onClick={onClose}
              className="text-slate-400 hover:text-amber transition-colors"
              aria-label="Close settings"
            >
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>

          {/* Settings Form */}
          <div className="space-y-5">
            {/* User Info */}
            <div>
              <label className="block text-sm font-medium text-slate-300 mb-2">
                Email
              </label>
              <div className="px-4 py-2.5 bg-mindpex-dark/50 border border-slate-700 rounded-lg text-slate-400 text-sm">
                {user?.email}
              </div>
            </div>

            {/* Nickname */}
            <div>
              <label className="block text-sm font-medium text-slate-300 mb-2">
                Display Name (Nickname)
              </label>
              <input
                type="text"
                value={nickname}
                onChange={(e) => setNickname(e.target.value)}
                placeholder="Enter a nickname (optional)"
                className="w-full px-4 py-2.5 bg-mindpex-dark/50 border border-amber/20 
                         rounded-lg text-slate-200 placeholder-slate-500
                         focus:border-amber focus:outline-none focus:ring-1 focus:ring-amber/50
                         transition-all"
                maxLength={30}
              />
              <p className="text-xs text-slate-500 mt-1.5">
                This is how MindPex will address you
              </p>
            </div>

            {/* Sound Effects */}
            <div className="flex items-center justify-between">
              <div>
                <label className="block text-sm font-medium text-slate-300">
                  Ambient Sound
                </label>
                <p className="text-xs text-slate-500 mt-0.5">
                  Background sanctuary sounds
                </p>
              </div>
              <button
                onClick={() => setSoundEnabled(!soundEnabled)}
                className={`relative w-12 h-6 rounded-full transition-colors ${
                  soundEnabled ? 'bg-amber' : 'bg-slate-600'
                }`}
              >
                <span
                  className={`absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full transition-transform ${
                    soundEnabled ? 'translate-x-6' : 'translate-x-0'
                  }`}
                />
              </button>
            </div>

            {/* Notifications */}
            <div className="flex items-center justify-between">
              <div>
                <label className="block text-sm font-medium text-slate-300">
                  Check-in Reminders
                </label>
                <p className="text-xs text-slate-500 mt-0.5">
                  Weekly emotional check-ins
                </p>
              </div>
              <button
                onClick={() => setNotificationsEnabled(!notificationsEnabled)}
                className={`relative w-12 h-6 rounded-full transition-colors ${
                  notificationsEnabled ? 'bg-amber' : 'bg-slate-600'
                }`}
              >
                <span
                  className={`absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full transition-transform ${
                    notificationsEnabled ? 'translate-x-6' : 'translate-x-0'
                  }`}
                />
              </button>
            </div>

            {/* Data & Privacy */}
            <div className="pt-4 border-t border-slate-700">
              <h3 className="text-sm font-medium text-slate-300 mb-3">Data & Privacy</h3>
              <button
                onClick={() => {
                  // TODO: Implement data export
                  alert('Export feature coming soon');
                }}
                className="w-full text-left px-4 py-2.5 text-sm text-slate-300 
                         hover:bg-amber/10 rounded-lg transition-colors"
              >
                Export My Data
              </button>
              <button
                onClick={() => {
                  if (confirm('Are you sure you want to delete all your conversation history? This cannot be undone.')) {
                    // TODO: Implement data deletion
                    alert('Delete feature coming soon');
                  }
                }}
                className="w-full text-left px-4 py-2.5 text-sm text-red-400 
                         hover:bg-red-400/10 rounded-lg transition-colors mt-1"
              >
                Delete Conversation History
              </button>
            </div>

            {/* Message */}
            {message && (
              <div className={`text-sm text-center py-2 rounded-lg ${
                message.includes('success') 
                  ? 'text-green-400 bg-green-400/10' 
                  : 'text-red-400 bg-red-400/10'
              }`}>
                {message}
              </div>
            )}

            {/* Save Button */}
            <button
              onClick={handleSave}
              disabled={loading}
              className="w-full py-3 bg-amber text-white font-semibold rounded-lg
                       hover:bg-amber-glow hover:shadow-lg hover:shadow-amber/30 
                       disabled:opacity-50 disabled:cursor-not-allowed
                       transition-all duration-200"
            >
              {loading ? 'Saving...' : 'Save Changes'}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};
